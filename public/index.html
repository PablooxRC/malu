<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALU - Polimorfismo Usuario/Chofer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .left-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: fit-content;
        }

        .right-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .panel-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        input[type="number"]:focus,
        input[type="file"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            background: #5568d3;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #764ba2;
            color: white;
        }

        .btn-secondary:hover {
            background: #653a87;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .status-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .response-container {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .driver-card {
            background: #f7fafc;
            border-left: 4px solid #48bb78;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .driver-card h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .driver-card p {
            margin: 5px 0;
            color: #555;
            font-size: 0.9em;
        }

        .token-display {
            background: #edf2f7;
            border: 1px dashed #667eea;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            color: #555;
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            color: #999;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #c6f6d5;
            border-left-color: #48bb78;
            color: #22543d;
        }

        .alert-error {
            background: #fed7d7;
            border-left-color: #f56565;
            color: #742a2a;
        }

        .alert-warning {
            background: #feebc8;
            border-left-color: #ed8936;
            color: #7c2d12;
        }

        .alert-info {
            background: #bee3f8;
            border-left-color: #4299e1;
            color: #2c5282;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            display: none;
            text-align: center;
            margin: 15px 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üöï MALU - Polimorfismo Usuario/Chofer</h1>
            <p>Panel de Pruebas de API</p>
        </header>

        <div class="main-grid">
            <!-- Left Panel - Navigation -->
            <div class="left-panel">
                <div class="panel-title">üìã Men√∫</div>
                
                <div class="tabs" style="flex-direction: column; border-bottom: none;">
                    <button class="tab-btn active" onclick="switchTab('auth')">üîê Autenticaci√≥n</button>
                    <button class="tab-btn" onclick="switchTab('usuario')">üë§ Usuario</button>
                    <button class="tab-btn" onclick="switchTab('friends')">ü§ù Amigos</button>
                    <button class="tab-btn" onclick="switchTab('chofer')">üöó Chofer</button>
                    <button class="tab-btn" onclick="switchTab('listar')">üìç Listar</button>
                    <button id="adminTabBtn" class="tab-btn" style="display:none;" onclick="switchTab('admin')">üõ†Ô∏è Admin</button>
                    <button class="tab-btn" onclick="switchTab('estado')">‚öôÔ∏è Sistema</button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #edf2f7; border-radius: 5px;">
                    <strong>Estado de Sesi√≥n:</strong>
                    <div id="sessionStatus" class="status-badge status-warning" style="display: block; margin-top: 10px;">
                        ‚ùå No autenticado
                    </div>
                    <div id="userInfo" style="margin-top: 10px; font-size: 0.9em; color: #555;"></div>
                </div>
            </div>

            <!-- Right Panel - Content -->
            <div class="right-panel">
                <!-- Autenticaci√≥n -->
                <div id="auth" class="tab-content active">
                    <div class="panel-title">üîê Autenticaci√≥n</div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Registrar Usuario</h3>
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="reg_username" placeholder="juan_test">
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a</label>
                            <input type="password" id="reg_password" placeholder="password123">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="text" id="reg_phone" placeholder="5491234567890">
                        </div>
                        <button class="btn-primary" onclick="register()">Registrar</button>
                        <div id="registerResponse" class="response-container" style="display: none;"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Login</h3>
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="login_username" placeholder="juan_test">
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a</label>
                            <input type="password" id="login_password" placeholder="password123">
                        </div>
                        <button class="btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
                        <div id="loginResponse" class="response-container" style="display: none;"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Logout</h3>
                        <button class="btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
                        <div id="logoutResponse" class="response-container" style="display: none;"></div>
                    </div>
                </div>

                <!-- Usuario -->
                <div id="usuario" class="tab-content">
                    <div class="panel-title">üë§ Operaciones de Usuario</div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Obtener Perfil</h3>
                        <p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">Requiere estar autenticado</p>
                        <button class="btn-primary" onclick="getProfile()">Obtener Perfil</button>
                        <div id="profileResponse" class="response-container" style="display: none;"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Verificar Tel√©fono</h3>
                        <p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">Ingresa el c√≥digo recibido por WhatsApp</p>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="text" id="verify_phone" placeholder="5491234567890">
                        </div>
                        <div class="form-group">
                            <label>C√≥digo de Verificaci√≥n</label>
                            <input type="text" id="verify_code" placeholder="123456">
                        </div>
                        <button class="btn-primary" onclick="verifyPhone()">Verificar</button>
                        <div id="verifyResponse" class="response-container" style="display: none;"></div>
                    </div>
                </div>

                <!-- Amigos -->
                <div id="friends" class="tab-content">
                    <div class="panel-title">ü§ù Gesti√≥n de Amigos</div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Enviar Solicitud de Amistad</h3>
                        <p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">Ingresa el nombre de usuario (username) al que deseas enviar la solicitud</p>
                        <div class="form-group">
                                <label>Nombre de usuario (username)</label>
                                <input type="text" id="friend_target_username" placeholder="username destino">
                            </div>
                            <button class="btn-primary" onclick="sendFriendRequest()">Enviar Solicitud</button>
                        <div id="friendRequestResponse" class="response-container" style="display: none;"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Solicitudes Recibidas</h3>
                        <button class="btn-primary" onclick="loadFriendRequests()">Cargar Solicitudes</button>
                        <div id="friendRequestsList" style="margin-top: 15px;"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Mis Amigos</h3>
                        <button class="btn-primary" onclick="loadFriends()">Cargar Amigos</button>
                        <div id="friendsList" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- Chofer -->
                <div id="chofer" class="tab-content">
                    <div class="panel-title">üöó Operaciones de Chofer</div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Registrarse como Chofer</h3>
                        <p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">Requiere estar autenticado y verificado</p>
                        
                        <div class="form-group">
                            <label>Placa del Veh√≠culo</label>
                            <input type="text" id="car_plate" placeholder="ABC123" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Color</label>
                            <input type="text" id="car_color" placeholder="Rojo">
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Marca</label>
                                <input type="text" id="car_brand" placeholder="Honda">
                            </div>
                            <div class="form-group">
                                <label>Modelo</label>
                                <input type="text" id="car_model" placeholder="Civic">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>A√±o</label>
                            <input type="number" id="car_year" placeholder="2022" min="1900" max="2099">
                        </div>
                        <div class="form-group">
                            <label>Carnet de Identidad - Anverso (JPG, PNG, PDF - M√°x 5MB)</label>
                            <input type="file" id="idCardFront" accept=".jpg,.jpeg,.png,.pdf">
                        </div>
                        <div class="form-group">
                            <label>Carnet de Identidad - Reverso (JPG, PNG, PDF - M√°x 5MB)</label>
                            <input type="file" id="idCardBack" accept=".jpg,.jpeg,.png,.pdf">
                        </div>
                        <button class="btn-primary" onclick="registerAsDriver()">Registrarse como Chofer</button>
                        <div id="driverRegisterResponse" class="response-container" style="display: none;"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Actualizar Disponibilidad</h3>
                        <p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">Requiere estar autenticado como chofer</p>
                        <div class="form-group">
                            <label>¬øDisponible?</label>
                            <select id="availability">
                                <option value="true">S√≠, disponible</option>
                                <option value="false">No, no disponible</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="updateAvailability()">Actualizar</button>
                        <div id="availabilityResponse" class="response-container" style="display: none;"></div>
                    </div>
                </div>

                <!-- Listar -->
                <div id="listar" class="tab-content">
                    <div class="panel-title">üìç Listar Elementos</div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Choferes Disponibles</h3>
                        <button class="btn-primary" onclick="getAvailableDrivers()">Cargar Choferes</button>
                        <div id="driversResponse" class="response-container" style="display: none;"></div>
                        <div id="driversList"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Informaci√≥n de Chofer Espec√≠fico</h3>
                        <div class="form-group">
                            <label>ID del Chofer</label>
                            <input type="text" id="driver_id" placeholder="ID del chofer">
                        </div>
                        <button class="btn-primary" onclick="getDriverInfo()">Obtener Info</button>
                        <div id="driverInfoResponse" class="response-container" style="display: none;"></div>
                    </div>
                </div>

                <!-- Admin -->
                <div id="admin" class="tab-content">
                    <div class="panel-title">üõ†Ô∏è Panel Admin - Verificaciones</div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Cola de Verificaciones</h3>
                        <p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">Muestra choferes cuya verificaci√≥n requiere revisi√≥n.</p>
                        <button class="btn-primary" onclick="loadVerificationQueue()">Cargar Cola</button>
                        <div id="adminQueueResponse" class="response-container" style="display: none;"></div>
                        <div id="adminQueueList" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- Sistema -->
                <div id="estado" class="tab-content">
                    <div class="panel-title">‚öôÔ∏è Estado del Sistema</div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Estado del Servidor</h3>
                        <button class="btn-primary" onclick="getStatus()">Verificar Estado</button>
                        <div id="statusResponse" class="response-container" style="display: none;"></div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Informaci√≥n de la API</h3>
                        <div class="response-container" style="border-left-color: #667eea;">
Base URL: http://localhost:3000

Endpoints Principales:
- POST /user/register
- POST /user/login
- POST /user/logout
- GET /user/profile
- POST /user/verifyphone
- POST /driver/become-driver
- PATCH /driver/driver/availability
- GET /driver/drivers/available
- GET /driver/driver/:id
- GET /status
                        </div>
                    </div>

                    <div class="section">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Limpiar Sesi√≥n Local</h3>
                        <button class="btn-danger" onclick="clearLocalStorage()">Borrar Todo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3000';
        let token = localStorage.getItem('token');
        let currentUser = JSON.parse(localStorage.getItem('user') || '{}');

        // Actualizar estado de sesi√≥n
        function updateSessionStatus() {
            const statusEl = document.getElementById('sessionStatus');
            const userInfoEl = document.getElementById('userInfo');

            if (token && currentUser.username) {
                statusEl.className = 'status-badge status-success';
                statusEl.textContent = '‚úÖ Autenticado como: ' + currentUser.username;
                userInfoEl.innerHTML = `
                    <strong>Informaci√≥n:</strong><br>
                    Usuario: ${currentUser.username}<br>
                    Tel√©fono: ${currentUser.phone}<br>
                    Rol: ${currentUser.role || 'usuario'}
                `;
                // Mostrar pesta√±a Admin si es admin
                const adminBtn = document.getElementById('adminTabBtn');
                if (adminBtn) adminBtn.style.display = (currentUser.role === 'admin') ? 'block' : 'none';
            } else {
                statusEl.className = 'status-badge status-warning';
                statusEl.textContent = '‚ùå No autenticado';
                userInfoEl.innerHTML = '';
                const adminBtn = document.getElementById('adminTabBtn');
                if (adminBtn) adminBtn.style.display = 'none';
            }
        }

        // Cambiar tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Mostrar respuesta formateada
        function showResponse(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.textContent = JSON.stringify(data, null, 2);
            el.className = 'response-container ' + (isError ? 'alert-error' : '');
        }

        // Registro
        async function register() {
            const username = document.getElementById('reg_username').value;
            const password = document.getElementById('reg_password').value;
            const phone = document.getElementById('reg_phone').value;

            if (!username || !password || !phone) {
                alert('Por favor completa todos los campos');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/user/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, phone })
                });

                const data = await response.json();
                showResponse('registerResponse', data, !data.success);
            } catch (error) {
                showResponse('registerResponse', { error: error.message }, true);
            }
        }

        // Login
        async function login() {
            const username = document.getElementById('login_username').value;
            const password = document.getElementById('login_password').value;

            if (!username || !password) {
                alert('Por favor completa todos los campos');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/user/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (data.success && data.token) {
                    token = data.token;
                    currentUser = data.user;
                    localStorage.setItem('token', token);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateSessionStatus();
                    alert('‚úÖ Login exitoso');
                }
                
                showResponse('loginResponse', data, !data.success);
            } catch (error) {
                showResponse('loginResponse', { error: error.message }, true);
            }
        }

        // Logout
        async function logout() {
            if (!token) {
                alert('No hay sesi√≥n activa');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/user/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (data.success) {
                    token = null;
                    currentUser = {};
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    updateSessionStatus();
                    alert('‚úÖ Sesi√≥n cerrada');
                }
                
                showResponse('logoutResponse', data, !data.success);
            } catch (error) {
                showResponse('logoutResponse', { error: error.message }, true);
            }
        }

        // Obtener Perfil
        async function getProfile() {
            if (!token) {
                alert('Debes estar autenticado');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/user/profile`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                showResponse('profileResponse', data, !data.success);
            } catch (error) {
                showResponse('profileResponse', { error: error.message }, true);
            }
        }

        // Verificar Tel√©fono
        async function verifyPhone() {
            const phone = document.getElementById('verify_phone').value;
            const code = document.getElementById('verify_code').value;

            if (!phone || !code) {
                alert('Por favor completa todos los campos');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/user/verifyphone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, code })
                });

                const data = await response.json();
                showResponse('verifyResponse', data, !data.success);
            } catch (error) {
                showResponse('verifyResponse', { error: error.message }, true);
            }
        }

        // Registrar como Chofer
        async function registerAsDriver() {
            if (!token) {
                alert('Debes estar autenticado');
                return;
            }

            const plate = document.getElementById('car_plate').value.toUpperCase();
            const color = document.getElementById('car_color').value;
            const brand = document.getElementById('car_brand').value;
            const model = document.getElementById('car_model').value;
            const year = document.getElementById('car_year').value;
            const fileFront = document.getElementById('idCardFront');
            const fileBack = document.getElementById('idCardBack');

            if (!plate || !color || !brand || !model || !year || !fileFront.files[0] || !fileBack.files[0]) {
                alert('Por favor completa todos los campos e incluye ambos lados del carnet');
                return;
            }

            const formData = new FormData();
            formData.append('plate', plate);
            formData.append('color', color);
            formData.append('brand', brand);
            formData.append('model', model);
            formData.append('year', year);
            formData.append('idCardFront', fileFront.files[0]);
            formData.append('idCardBack', fileBack.files[0]);

            try {
                const response = await fetch(`${BASE_URL}/driver/become-driver`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await response.json();
                showResponse('driverRegisterResponse', data, !data.success);
                
                if (data.success) {
                    currentUser = data.driver;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateSessionStatus();
                }
            } catch (error) {
                showResponse('driverRegisterResponse', { error: error.message }, true);
            }
        }

        // Actualizar Disponibilidad
        async function updateAvailability() {
            if (!token) {
                alert('Debes estar autenticado');
                return;
            }

            const isAvailable = document.getElementById('availability').value === 'true';

            try {
                const response = await fetch(`${BASE_URL}/driver/driver/availability`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isAvailable })
                });

                const data = await response.json();
                showResponse('availabilityResponse', data, !data.success);
            } catch (error) {
                showResponse('availabilityResponse', { error: error.message }, true);
            }
        }

        // Obtener Choferes Disponibles
        async function getAvailableDrivers() {
            try {
                const response = await fetch(`${BASE_URL}/driver/drivers/available`, {
                    method: 'GET'
                });

                const data = await response.json();
                showResponse('driversResponse', data, !data.success);

                if (data.success && data.drivers && data.drivers.length > 0) {
                    let html = '<div style="margin-top: 20px;">';
                    data.drivers.forEach(driver => {
                        html += `
                            <div class="driver-card">
                                <h4>üë§ ${driver.username}</h4>
                                <p><strong>Tel√©fono:</strong> ${driver.phone}</p>
                                <p><strong>Auto:</strong> ${driver.car.brand} ${driver.car.model} (${driver.car.year})</p>
                                <p><strong>Placa:</strong> ${driver.car.plate} | <strong>Color:</strong> ${driver.car.color}</p>
                                <p><strong>‚≠ê Calificaci√≥n:</strong> ${driver.rating} | <strong>Viajes:</strong> ${driver.completedTrips}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('driversList').innerHTML = html;
                }
            } catch (error) {
                showResponse('driversResponse', { error: error.message }, true);
            }
        }

        // Obtener Info de Chofer
        async function getDriverInfo() {
            const driverId = document.getElementById('driver_id').value;

            if (!driverId) {
                alert('Por favor ingresa el ID del chofer');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/driver/driver/${driverId}`, {
                    method: 'GET'
                });

                const data = await response.json();
                showResponse('driverInfoResponse', data, !data.success);
            } catch (error) {
                showResponse('driverInfoResponse', { error: error.message }, true);
            }
        }

        // Obtener Estado
        async function getStatus() {
            try {
                const response = await fetch(`${BASE_URL}/status`, {
                    method: 'GET'
                });

                const data = await response.json();
                showResponse('statusResponse', data);
            } catch (error) {
                showResponse('statusResponse', { error: error.message }, true);
            }
        }

        // Limpiar LocalStorage
        function clearLocalStorage() {
            if (confirm('¬øEst√°s seguro? Se borrar√°n todos los datos locales.')) {
                localStorage.clear();
                token = null;
                currentUser = {};
                updateSessionStatus();
                alert('‚úÖ Datos locales borrados');
            }
        }

        // ==================== Admin functions ====================
        async function loadVerificationQueue() {
            if (!token) { alert('Debes estar autenticado como admin'); return; }
            try {
                const response = await fetch(`${BASE_URL}/driver/admin/verify-queue`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                showResponse('adminQueueResponse', data, !data.success);
                const listEl = document.getElementById('adminQueueList');
                listEl.innerHTML = '';
                if (data.success && data.queue && data.queue.length) {
                    data.queue.forEach(d => {
                        const html = `
                            <div class="driver-card">
                                <h4>üë§ ${d.username} <small style="color:#666;">(${d._id})</small></h4>
                                <p><strong>Tel√©fono:</strong> ${d.phone}</p>
                                <p><strong>Auto:</strong> ${d.car.brand} ${d.car.model} (${d.car.year})</p>
                                <p><strong>Verificaci√≥n:</strong> ${d.verification?.status || 'pending'} | Score: ${d.verification?.score ?? 'N/A'}</p>
                                <div style="margin-top:8px;">
                                    <button class="btn-secondary btn-small" onclick="window.open('${BASE_URL}/driver/document/${d._id}?side=front','_blank')">Ver Anverso</button>
                                    <button class="btn-secondary btn-small" onclick="window.open('${BASE_URL}/driver/document/${d._id}?side=back','_blank')">Ver Reverso</button>
                                    <button class="btn-success btn-small" onclick="adminApprove('${d._id}')">Aprobar</button>
                                    <button class="btn-danger btn-small" onclick="adminRejectPrompt('${d._id}')">Rechazar</button>
                                </div>
                            </div>
                        `;
                        listEl.insertAdjacentHTML('beforeend', html);
                    });
                } else {
                    listEl.innerHTML = '<div class="alert alert-info">No hay verificaciones pendientes.</div>';
                }
            } catch (error) {
                showResponse('adminQueueResponse', { error: error.message }, true);
            }
        }

        async function adminApprove(id) {
            if (!confirm('Confirmar aprobaci√≥n del chofer?')) return;
            try {
                const response = await fetch(`${BASE_URL}/driver/admin/verify/${id}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'approve' })
                });
                const data = await response.json();
                alert(data.message || 'Operaci√≥n completada');
                loadVerificationQueue();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function adminRejectPrompt(id) {
            const reason = prompt('Motivo del rechazo (opcional):');
            if (reason === null) return; // cancel
            adminReject(id, reason);
        }

        async function adminReject(id, reason) {
            try {
                const response = await fetch(`${BASE_URL}/driver/admin/verify/${id}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reject', comment: reason })
                });
                const data = await response.json();
                alert(data.message || 'Operaci√≥n completada');
                loadVerificationQueue();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            updateSessionStatus();
        });

        // ==================== Friends functions ====================
        async function sendFriendRequest() {
            if (!token) { alert('Debes estar autenticado'); return; }
            const username = document.getElementById('friend_target_username').value.trim();
            if (!username) { alert('Ingresa un nombre de usuario destino'); return; }
            try {
                const resp = await fetch(`${BASE_URL}/user/friend-request-by-username`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await resp.json();
                showResponse('friendRequestResponse', data, !data.success);
            } catch (err) {
                showResponse('friendRequestResponse', { error: err.message }, true);
            }
        }

        async function loadFriendRequests() {
            if (!token) { alert('Debes estar autenticado'); return; }
            try {
                const resp = await fetch(`${BASE_URL}/user/me/friend-requests`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await resp.json();
                const listEl = document.getElementById('friendRequestsList');
                listEl.innerHTML = '';
                if (!data.success) { showResponse('friendRequestResponse', data, true); return; }
                if (data.count === 0) { listEl.innerHTML = '<div class="alert alert-info">No tienes solicitudes pendientes.</div>'; return; }
                data.requests.forEach(r => {
                    const id = r.from?._id || (r.from && r.from.toString()) || r.from;
                    const name = r.from?.username || r.from?.phone || 'Usuario';
                    const html = `
                        <div class="driver-card">
                            <h4>üë§ ${name} <small style="color:#666;">(${id})</small></h4>
                            <p>Enviado: ${new Date(r.createdAt).toLocaleString()}</p>
                            <div style="margin-top:8px;">
                                <button class="btn-success btn-small" onclick="acceptFriendRequest('${id}')">Aceptar</button>
                                <button class="btn-danger btn-small" onclick="declineFriendRequest('${id}')">Rechazar</button>
                            </div>
                        </div>
                    `;
                    listEl.insertAdjacentHTML('beforeend', html);
                });
            } catch (err) {
                showResponse('friendRequestResponse', { error: err.message }, true);
            }
        }

        async function acceptFriendRequest(fromId) {
            if (!token) { alert('Debes estar autenticado'); return; }
            try {
                const resp = await fetch(`${BASE_URL}/user/friend-request/${fromId}/accept`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                const data = await resp.json();
                alert(data.message || 'Solicitud aceptada');
                loadFriendRequests();
                loadFriends();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function declineFriendRequest(fromId) {
            if (!token) { alert('Debes estar autenticado'); return; }
            try {
                const resp = await fetch(`${BASE_URL}/user/friend-request/${fromId}/decline`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                const data = await resp.json();
                alert(data.message || 'Solicitud rechazada');
                loadFriendRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function loadFriends() {
            if (!token) { alert('Debes estar autenticado'); return; }
            try {
                const resp = await fetch(`${BASE_URL}/user/me/friends`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await resp.json();
                const listEl = document.getElementById('friendsList');
                listEl.innerHTML = '';
                if (!data.success) { listEl.innerHTML = `<div class="alert alert-error">${data.message || 'Error'}</div>`; return; }
                if (data.count === 0) { listEl.innerHTML = '<div class="alert alert-info">No tienes amigos a√∫n.</div>'; return; }
                data.friends.forEach(f => {
                    const html = `
                        <div class="driver-card">
                            <h4>üë§ ${f.username} <small style="color:#666;">(${f._id})</small></h4>
                            <p><strong>Tel√©fono:</strong> ${f.phone || 'N/A'}</p>
                            <div style="margin-top:8px;">
                                <button class="btn-danger btn-small" onclick="removeFriend('${f._id}')">Eliminar Amigo</button>
                            </div>
                        </div>
                    `;
                    listEl.insertAdjacentHTML('beforeend', html);
                });
            } catch (err) { listEl.innerHTML = `<div class="alert alert-error">${err.message}</div>`; }
        }

        async function removeFriend(id) {
            if (!token) { alert('Debes estar autenticado'); return; }
            if (!confirm('Eliminar amigo?')) return;
            try {
                const resp = await fetch(`${BASE_URL}/user/friends/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await resp.json();
                alert(data.message || 'Operaci√≥n completada');
                loadFriends();
            } catch (err) { alert('Error: ' + err.message); }
        }
    </script>
</body>
</html>
